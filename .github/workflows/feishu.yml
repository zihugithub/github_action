name: FeiShu CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.actor }}
  cancel-in-progress: true

jobs:
  set-env:
    runs-on: ubuntu-latest
    outputs:
      ci_image: ${{ steps.set-image.outputs.ci_image }} # Declare output variable
      test_tasks: ${{ steps.set-tasks.outputs.test_tasks }}
      test_type: ${{ steps.set-type.outputs.test_type }}
    steps:
      - name: Set CI base Image
        id: set-image
        run: |
          echo "ci_image=localhost:5000/flagscale:maca.ai2.33.0.13-torch2.6-py310-ubuntu22.04-amd64-time2508051515" >> $GITHUB_OUTPUT  # Set output variable
      - name: Set Test Tasks
        id: set-tasks
        run: |
          echo "test_tasks=deepseek_r1_distill_qwen-metax,opi_llama3_1_instruct-metax,opi_llama3_1_instruct-flaggems-metax,qwen3-metax,qwen3-flaggems-metax" >> $GITHUB_OUTPUT
      - name: Set Test Type
        id: set-type
        run: |
          echo "test_type=inference" >> $GITHUB_OUTPUT

  start-and-check-containers:
    needs: set-env
    runs-on:  [self-hosted, Linux, X64, yfb_metax2]
    services:
      ci-env:
        image: ${{ needs.set-env.outputs.ci_image }}
        options: >-
          --ipc=host
          --privileged=true
          --group-add video
          --shm-size 100gb
          --hostname flagscale_cicd
          --user root
          --ulimit nofile=65535:65535
          --ulimit memlock=-1
          --device=/dev/dri
          --device=/dev/mxcd
        ports:
          - 80
    # outputs:
    #   container_id: ${{ steps.capture_id.outputs.container_id }}

    steps:
      # - name: Checkout Code
      #   uses: actions/checkout@v4
      #   with:
      #     repository: ${{ github.event.pull_request.head.repo.full_name }}
      #     ref: ${{ github.event.pull_request.head.ref }}
      #     fetch-depth: 0
      #     ssh-strict: true
      #     ssh-user: git
      #     persist-credentials: true
      #     clean: true
      #     sparse-checkout-cone-mode: true
      #     fetch-tags: false
      #     show-progress: true
      #     lfs: false
      #     submodules: false
      #     set-safe-directory: true

      - name: Setup Environment Info
        id: capture_id
        run: |
          echo "USER: $USER"
          echo "UID: $(id -u)"
          echo "GID: $(id -g)"
          echo "Home: $HOME"
          echo "PWD: ${PWD}"
          echo "Using_image: ${{ needs.set-env.outputs.ci_image }}"
          /usr/bin/docker version --format '{{.Server.APIVersion}}'
          /usr/bin/docker version --format '{{.Client.APIVersion}}'
          # CONTAINER_ID="$(docker ps --filter "ancestor=${{ needs.set-env.outputs.ci_image }}" --format="{{.ID}}")"
          # echo "CONTAINER_ID: ${CONTAINER_ID}"
          # /usr/bin/docker ps --filter "ancestor=${{ needs.set-env.outputs.ci_image }}" --format="{{.ID}}" # 无法输出
          # docker ps -a --format "table {{.ID}}\t{{.Image}}" | grep "${{ needs.set-env.outputs.ci_image }}"
          # /usr/bin/docker ps --format="{{.ID}}"
          # /usr/bin/docker ps --filter "label=org.opencontainers.image.ref=${{ needs.set-env.outputs.ci_image }}" --format="{{.ID}}"  # 无法输出
          # docker ps --all --format "table {{.ID}}\t{{.Names}}\t{{.Labels}}"
          CONTAINER_ID="$(/usr/bin/docker ps -a --format "{{.ID}} {{.Names}}" | grep "localhost5000" | cut -d ' ' -f 1)"
          echo "CONTAINER_ID: ${CONTAINER_ID}"

#   save-and-cleanup:
#     needs: start-and-check-containers
#     runs-on:  [self-hosted, Linux, X64, yfb_metax2]
#     steps:
#       - name: Save running container as image
#         run: |
#           # CONTAINER_ID="${{ needs.start-and-check-containers.outputs.container_id }}"
#           CONTAINER_ID="$(docker ps --filter "ancestor=${{ needs.set-env.outputs.ci_image }}" --format="{{.ID}}")"
#           echo ${CONTAINER_ID}

# # ******************************************************************************************8
#   feishu-notice:
#     needs: save-and-cleanup
#     runs-on:  [self-hosted, Linux, X64, yfb_metax2]
#     steps:
#       - name: Set repository context variables
#         if: always()
#         run: |
#           echo "GITHUB_WORKFLOW=${{ github.workflow }}" >> ${GITHUB_ENV}
#           echo "JOB_STATUS=${{ job.status }}" >> ${GITHUB_ENV}
#           echo "REPO_URL=https://github.com/${{ github.repository }}.git" >> ${GITHUB_ENV}
#           # echo "BRANCH_TARGET=${{ github.event.pull_request.head.ref }}" >> ${GITHUB_ENV}
#           echo "GITHUB_SHA=${{ github.sha }}" >> ${GITHUB_ENV}
#           echo "AUTHOR_NAME=${{ github.event.head_commit.author.name }}" >> ${GITHUB_ENV}
#           echo "AUTHOR_EMAIL=${{ github.event.head_commit.author.email }}" >> ${GITHUB_ENV}

#           cat ${GITHUB_ENV}

#       - name: Send Feishu notification
#         uses: NewGr8Player/feishu-message-action@v1
#         with:
#           webhook: ${{ secrets.FEISHU_WEBHOOK }}
#           type: post
#           message: '{
#             "post":{
#               "zh_cn":{
#                 "title":"flagscale → ${{ env.GITHUB_WORKFLOW }}工作流构建结果通知",
#                 "content":[
#                   [
#                     {"tag":"text","text":"Job 当前状态: ${{ env.JOB_STATUS }}"}
#                   ],
#                   [
#                     {"tag":"text","text":"仓库名: ${{ env.REPO_URL }}"}
#                   ], 
#                   [
#                     {"tag":"text","text":"目标分支: ${{ env.BRANCH_TARGET }}"}
#                   ],
#                   [
#                     {"tag":"text","text":"提交哈希: ${{ env.GITHUB_SHA }}"}
#                   ],
#                   [
#                     {"tag":"text","text":"贡献者: ${{ env.AUTHOR_NAME }} (Email: ${{ env.AUTHOR_EMAIL }})"}
#                   ]
#                 ]
#               }
#             }
#           }'

# CONTAINER ID   NAMES                                                                                                                 LABELS
# 46f702e742ff   cf13c864d07d4f1d91e87b2f98438d0c_localhost5000flagscalemacaai233013torch26py310ubuntu2204amd64time2508051515_6543ad   d2eadf=,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04,com.metax.driver.version=2.33.0.9,com.metax.sdk.version=2.33.0.12,com.metax.torch.version=2.6+2.33.0.5
# 742b694ac110   test_0924ye                                                                                                           com.metax.driver.version=3.0.0.5,com.metax.sdk.version=3.0.0.8,com.metax.torch.version=2.6+3.0.0.3,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04
# 8e14709ca32e   test0923ye                                                                                                            com.metax.driver.version=3.0.0.5,com.metax.sdk.version=3.0.0.8,com.metax.torch.version=2.6+3.0.0.3,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04
# a38c154febff   metax-0911                                                                                                            com.metax.driver.version=3.0.0.5,com.metax.sdk.version=3.0.0.8,com.metax.torch.version=2.6+3.0.0.3,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04
# cd34ee23639f   metax-vllm-0.9.1                                                                                                      com.metax.driver.version=3.0.0.5,com.metax.sdk.version=3.0.0.8,com.metax.torch.version=2.6+3.0.0.3,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04
# 01dc6218414d   nifty_ritchie                                                                                                         com.metax.driver.version=3.0.0.5,com.metax.sdk.version=3.0.0.8,com.metax.torch.version=2.6+3.0.0.3,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04
# e37a9117d8d5   wonderful_bose                                                                                                        org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04,com.metax.driver.version=3.0.0.5,com.metax.sdk.version=3.0.0.8,com.metax.torch.version=2.6+3.0.0.3
# 976338c9f163   gifted_ptolemy                                                                                                        com.metax.driver.version=3.0.0.5,com.metax.sdk.version=3.0.0.8,com.metax.torch.version=2.6+3.0.0.3,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04
# 0bc593814805   wizardly_keller                                                                                                       com.metax.torch.version=2.6+3.0.0.3,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04,com.metax.driver.version=3.0.0.5,com.metax.sdk.version=3.0.0.8
# dca51ddd54db   metax-sscache-vllm                                                                                                    com.metax.driver.version=2.33.0.9,com.metax.sdk.version=2.33.0.12,com.metax.torch.version=2.6+2.33.0.5,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04
# f9ea75ad195f   elegant_franklin                                                                                                      com.metax.torch.version=2.6+3.0.0.3,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04,com.metax.driver.version=3.0.0.5,com.metax.sdk.version=3.0.0.8
# d20ba47b5f01   ecstatic_shamir                                                                                                       com.metax.sdk.version=3.0.0.8,com.metax.torch.version=2.6+3.0.0.3,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04,com.metax.driver.version=3.0.0.5
# ff45bea55a29   test250812ye                                                                                                          com.metax.driver.version=2.33.0.9,com.metax.sdk.version=2.33.0.12,com.metax.torch.version=2.6+2.33.0.5,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04
# a4d209f5a5ec   charming_lehmann                                                                                                      com.metax.driver.version=2.33.0.9,com.metax.sdk.version=2.33.0.12,com.metax.torch.version=2.6+2.33.0.5,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04
# d3954c2f3caf   practical_villani                                                                                                     com.metax.driver.version=2.33.0.9,com.metax.sdk.version=2.33.0.12,com.metax.torch.version=2.6+2.33.0.5,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04
# 8dfef347b264   hardcore_visvesvaraya                                                                                                 com.metax.driver.version=2.33.0.9,com.metax.sdk.version=2.33.0.12,com.metax.torch.version=2.6+2.33.0.5,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04
# 042d4ac0daa6   inspiring_bell                                                                                                        org.opencontainers.image.version=22.04,com.metax.driver.version=2.33.0.9,com.metax.sdk.version=2.33.0.12,com.metax.torch.version=2.6+2.33.0.5,org.opencontainers.image.ref.name=ubuntu
# 0ff564ef9c9b   cranky_bartik                                                                                                         com.metax.torch.version=2.6+2.33.0.5,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04,com.metax.driver.version=2.33.0.9,com.metax.sdk.version=2.33.0.12
# 1917f25593b0   dong_0801                                                                                                             com.metax.driver.version=2.33.0.9,com.metax.sdk.version=2.33.0.12,com.metax.torch.version=2.6+2.33.0.5,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04
# 81046a6345ee   dong_073116                                                                                                           org.opencontainers.image.version=22.04,com.metax.driver.version=2.33.0.9,com.metax.sdk.version=2.33.0.12,com.metax.torch.version=2.6+2.33.0.5,org.opencontainers.image.ref.name=ubuntu
# 0c93ed97bb22   dong_0731                                                                                                             com.metax.sdk.version=2.33.0.12,com.metax.torch.version=2.6+2.33.0.5,org.opencontainers.image.ref.name=ubuntu,org.opencontainers.image.version=22.04,com.metax.driver.version=2.33.0.9
# ed3ea24c3812   registry    