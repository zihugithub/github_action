name: FeiShu

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.actor }}
  cancel-in-progress: true

jobs:
  set-env:
    runs-on: ubuntu-latest
    outputs:
      ci_image: ${{ steps.set-image.outputs.ci_image }} # Declare output variable
      test_tasks: ${{ steps.set-tasks.outputs.test_tasks }}
      test_type: ${{ steps.set-type.outputs.test_type }}
    steps:
      - name: Set CI base Image
        id: set-image
        run: |
          echo "ci_image=localhost:5000/flagscale:maca.ai2.33.0.13-torch2.6-py310-ubuntu22.04-amd64-time2508051515" >> $GITHUB_OUTPUT  # Set output variable
      - name: Set Test Tasks
        id: set-tasks
        run: |
          echo "test_tasks=deepseek_r1_distill_qwen-metax,opi_llama3_1_instruct-metax,opi_llama3_1_instruct-flaggems-metax,qwen3-metax,qwen3-flaggems-metax" >> $GITHUB_OUTPUT
      - name: Set Test Type
        id: set-type
        run: |
          echo "test_type=inference" >> $GITHUB_OUTPUT

  FEISHU_TEST:
    needs: set-env
    runs-on:  [self-hosted, Linux, X64, yfb_metax2]
    container:
      image: ${{ needs.set-env.outputs.ci_image }}
      options: >-
        --ipc=host
        --privileged=true
        --group-add video
        --shm-size 100gb
        --hostname flagscale_cicd
        --user root
        --ulimit nofile=65535:65535
        --ulimit memlock=-1
        --device=/dev/dri
        --device=/dev/mxcd
      ports:
        - 80
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          ssh-strict: true
          ssh-user: git
          persist-credentials: true
          clean: true
          sparse-checkout-cone-mode: true
          fetch-tags: false
          show-progress: true
          lfs: false
          submodules: false
          set-safe-directory: true

      # - name: feishu # successful
      #   env:
      #     feishu_webhook: ${{ secrets.FEISHU_WEBHOOK }}
      #   run: |
      #     echo ${{ env.feishu_webhook }}
      #     curl -X POST ${{ env.feishu_webhook }} \
      #       -H "Content-Type: application/json" \
      #       -d '{
      #         "msg_type": "text",
      #         "content": {
      #           "text": "hello image (metax)"
      #         }
      #       }'

      # - name: Send custom message to Feishu
      #   uses: XRSec/feishu-bot-webhook-action@v1
      #   with:
      #     FEISHU_BOT_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
      #     MSG_TEXT: >- # if 判断无效
      #       {% if github.event_name == 'push' %}
      #         代码已推送到仓库flagscale! 提交人: ${{ github.actor }}
      #       {% else %}
      #         非推送事件忽略此条告警flagscale...
      #       {% endif %}

      - name: feishu # successful
        run: |
          apt update && apt install jq -y
          MSG="hello flagscale"
          # [[ -n ${{ env.feishu_webhook }} ]] || { echo "⚠️ WEBHOOK地址未配置!"; exit 1; }
          [[ -n ${MSG} ]] || { echo "⚠️ 消息内容不能为空！"; exit 1; }

          deploy=$(jq -n \
            --arg msg ${MSG}
            '{
              'msg_type': 'text',
              'content': {
                'text': "${msg}"
              }
            }')

          curl -X POST ${{ secrets.FEISHU_WEBHOOK }} \
            -H "Content-Type: application/json" \
            -d ${deploy} || echo "❌ 发送失败！"
